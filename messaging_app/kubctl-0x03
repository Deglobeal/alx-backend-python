#!/bin/bash

DEPLOYMENT_FILE="messaging_app/blue_deployment.yaml"
SERVICE_URL="http://messaging.local/api/"  # Change to your service endpoint

# Check if file exists and is not empty
if [ ! -s "$DEPLOYMENT_FILE" ]; then
    echo "âŒ Deployment file is missing or empty: $DEPLOYMENT_FILE"
    exit 1
fi

echo "ğŸš€ Applying rolling update..."
kubectl apply -f "$DEPLOYMENT_FILE"

echo "ğŸ“¡ Monitoring rollout status..."
kubectl rollout status deployment/messaging-app-blue

echo "ğŸ” Testing application for downtime..."
for i in {1..20}; do
    HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" "$SERVICE_URL")
    echo "Request $i â†’ HTTP $HTTP_CODE"
    sleep 1
done

echo "âœ… Checking current pods..."
kubectl get pods -l app=messaging-app,version=blue -o wide

echo "ğŸ¯ Rolling update complete!"
